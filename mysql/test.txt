DROP TABLE test;
CREATE TABLE test (
	id INT(11) NOT NULL,
	aaa VARCHAR(20) NOT NULL,
	bbb INT(10) NOT NULL,
	PRIMARY KEY (id),
	KEY idx_bbb(bbb) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE INDEX idx_bbb ON test(bbb);
ALTER TABLE test ADD INDEX idx_bbb(bbb);
ALTER TABLE test ADD CONSTRAINT unq_bbb UNIQUE(`bbb`);
ALTER TABLE test DROP INDEX unq_bbb;

DELETE FROM test;
INSERT INTO test VALUES(1, 'aaa1', 15);
INSERT INTO test VALUES(2, 'aaa2', 5);
INSERT INTO test VALUES(3, 'aaa3', 32);
INSERT INTO test VALUES(4, 'aaa4', 56);
INSERT INTO test VALUES(5, 'aaa5', 87);
INSERT INTO test VALUES(6, 'aaa6', 2);
INSERT INTO test VALUES(7, 'aaa7', 7);
INSERT INTO test VALUES(8, 'aaa8', 12);
INSERT INTO test VALUES(9, 'aaa9', 9);
INSERT INTO test VALUES(10, 'aaa0', 21);
SELECT * FROM test ORDER BY bbb;


INSERT INTO test VALUES(12, 'aaa12', 32);
INSERT INTO test VALUES(11, 'aaa11', 9);

INSERT INTO test VALUES(11, 'aaa11', 12);
INSERT INTO test VALUES(12, 'aaa12', 21);
INSERT INTO test VALUES(13, 'aaa13', 12);

INSERT INTO test VALUES(14, 'aaa14', 20);
INSERT INTO test VALUES(15, 'aaa15', 13);

INSERT INTO test VALUES(12, 'aaa12', 20);
INSERT INTO test VALUES(13, 'aaa13', 14);


2, 5, 7, 9, 12, 15, 21, 32, 56, 87


UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE id=9;
UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE id=3;

UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE id=8;
UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE id=10;

UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE bbb=12;
UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE bbb=21;

UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE bbb=15;
UPDATE test SET aaa=CONCAT(aaa, '_www') WHERE bbb=21;
========================================================
DROP TABLE uest;
CREATE TABLE uest (
	id INT(11) NOT NULL,
	ccc VARCHAR(20) NOT NULL,
	ddd INT(10) NOT NULL,
	PRIMARY KEY (id),
	KEY idx_ddd(ddd) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE INDEX idx_ccc ON uest(ccc);
DROP INDEX idx_ccc ON uest;

DELETE FROM uest;
INSERT INTO uest VALUES(1, 'abcd', 15);
INSERT INTO uest VALUES(2, 'bcde', 5);
INSERT INTO uest VALUES(3, 'cdef', 32);
INSERT INTO uest VALUES(4, 'defg', 56);
INSERT INTO uest VALUES(5, 'efgh', 21);
INSERT INTO uest VALUES(6, 'fghi', 2);
INSERT INTO uest VALUES(7, 'ghij', 7);
INSERT INTO uest VALUES(8, 'hijk', 12);
INSERT INTO uest VALUES(9, 'abcdef', 9);
INSERT INTO uest VALUES(10, 'bcdefg', 21);
INSERT INTO uest VALUES(11, 'cdefgh', 67);
INSERT INTO uest VALUES(12, 'abefgh', 41);
INSERT INTO uest VALUES(13, 'aefghi', 37);
INSERT INTO uest VALUES(14, 'abcfgh', 13);
INSERT INTO uest VALUES(15, 'cdeghes', 21);
INSERT INTO uest VALUES(16, 'cdghasdf', 18);
INSERT INTO uest VALUES(17, 'poijjs', 38);
INSERT INTO uest VALUES(18, 'lkjhhd', 25);
INSERT INTO uest VALUES(19, 'csadfdsafads', 4);
INSERT INTO uest VALUES(20, 'dwqfwqfwq', 76);

DROP TABLE zelation;
CREATE TABLE zelation (
	id INT(11) NOT NULL AUTO_INCREMENT,
	test_id INT(11) NOT NULL,
	uest_id INT(11) NOT NULL,
	ggg INT(11) NOT NULL,
	PRIMARY KEY (id),
	KEY idx_xxx(test_id, uest_id, ggg) USING BTREE,
	KEY idx_www(ggg, test_id, uest_id) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP INDEX idx_www ON zelation;
DROP INDEX idx_xxx ON zelation;
CREATE INDEX idx_xxx ON zelation(test_id, uest_id, ggg);
DROP INDEX idx_xxx ON zelation;
CREATE INDEX idx_xxx ON zelation(uest_id, test_id, ggg);

DELETE FROM zelation;
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(6, 13, 4);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(7, 5, 7);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(3, 2, 12);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(9, 15, 21);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(10, 11, 9);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(4, 9, 5);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(1, 4, 6);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(6, 10, 8);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(2, 7, 21);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(7, 20, 31);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(5, 10, 75);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(8, 16, 45);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(4, 6, 21);


SELECT AUTO_INCREMENT FROM information_schema.TABLES WHERE table_schema='ducati' AND table_name='zelation';

SELECT t.aaa,u.id AS uid,z.ggg,t.id AS tid,u.ccc,z.id AS zid FROM test t INNER JOIN zelation z ON t.id=z.test_id INNER JOIN uest u ON z.uest_id=u.id WHERE u.ddd=21;

UPDATE test t INNER JOIN zelation z ON t.id=z.test_id INNER JOIN uest u ON z.uest_id=u.id SET t.aaa=CONCAT(t.aaa,?),u.eee=CONCAT(s.ccc,?),z.ggg=t.ggg+? WHERE u.ddd=?;

DROP TABLE sub_test;
CREATE TABLE sub_test (
	id INT(11) NOT NULL,
	test_id INT(11) NOT NULL,
	eee VARCHAR(20) NOT NULL,
	fff INT(10) NOT NULL,
	PRIMARY KEY (id),
	KEY idx_xxx(test_id, fff) USING BTREE,
	KEY idx_www(fff, test_id) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

ALTER TABLE sub_test ADD CONSTRAINT unq_eee UNIQUE (`eee`);
ALTER TABLE sub_test ADD INDEX idx_test(test_id,fff);

DROP TABLE sub_test_test;
CREATE TABLE sub_test_test (
	id INT(11) NOT NULL,
	test_id INT(11) NOT NULL,
	eee VARCHAR(20) NOT NULL,
	fff INT(11) NOT NULL,
	hhh DECIMAL(10, 4) NOT NULL,
	creation_time TIME,
	PRIMARY KEY (id),
	KEY idx_pid(test_id) USING BTREE,
	KEY idx_fff(fff) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DELETE FROM s_updation;
DELETE FROM s_updation_row;
DELETE FROM s_updation_field;
DELETE FROM test;
INSERT INTO test VALUES(1, 'aaa1', 15);
INSERT INTO test VALUES(2, 'aaa2', 5);
INSERT INTO test VALUES(3, 'aaa3', 32);
INSERT INTO test VALUES(4, 'aaa4', 56);
INSERT INTO test VALUES(5, 'aaa5', 87);
INSERT INTO test VALUES(6, 'aaa6', 2);
INSERT INTO test VALUES(7, 'aaa7', 7);
INSERT INTO test VALUES(8, 'aaa8', 12);
INSERT INTO test VALUES(9, 'aaa9', 9);
INSERT INTO test VALUES(10, 'aaa0', 21);
DELETE FROM uest;
INSERT INTO uest VALUES(1, 'abcd', 15);
INSERT INTO uest VALUES(2, 'bcde', 5);
INSERT INTO uest VALUES(3, 'cdef', 32);
INSERT INTO uest VALUES(4, 'defg', 56);
INSERT INTO uest VALUES(5, 'efgh', 21);
INSERT INTO uest VALUES(6, 'fghi', 2);
INSERT INTO uest VALUES(7, 'ghij', 7);
INSERT INTO uest VALUES(8, 'hijk', 12);
INSERT INTO uest VALUES(9, 'abcdef', 9);
INSERT INTO uest VALUES(10, 'bcdefg', 21);
INSERT INTO uest VALUES(11, 'cdefgh', 67);
INSERT INTO uest VALUES(12, 'abefgh', 41);
INSERT INTO uest VALUES(13, 'aefghi', 37);
INSERT INTO uest VALUES(14, 'abcfgh', 13);
INSERT INTO uest VALUES(15, 'cdeghes', 21);
INSERT INTO uest VALUES(16, 'cdghasdf', 18);
INSERT INTO uest VALUES(17, 'poijjs', 38);
INSERT INTO uest VALUES(18, 'lkjhhd', 25);
INSERT INTO uest VALUES(19, 'csadfdsafads', 4);
INSERT INTO uest VALUES(20, 'dwqfwqfwq', 76);
DELETE FROM zelation;
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(6, 13, 4);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(7, 5, 7);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(3, 2, 12);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(9, 15, 54);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(10, 11, 9);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(4, 9, 5);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(1, 4, 6);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(6, 10, 8);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(2, 7, 21);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(7, 20, 31);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(5, 10, 75);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(8, 16, 45);
INSERT INTO zelation(test_id, uest_id, ggg) VALUES(4, 6, 92);
DELETE FROM sub_test;
INSERT INTO sub_test VALUES(1, 6, 'abcd', 15);
INSERT INTO sub_test VALUES(2, 2, 'bcde', 5);
INSERT INTO sub_test VALUES(3, 5, 'cdef', 21);
INSERT INTO sub_test VALUES(4, 7, 'defg', 56);
INSERT INTO sub_test VALUES(5, 1, 'efgh', 87);
INSERT INTO sub_test VALUES(6, 10, 'fghi', 2);
INSERT INTO sub_test VALUES(7, 3, 'ghij', 7);
INSERT INTO sub_test VALUES(8, 9, 'hijk', 12);
INSERT INTO sub_test VALUES(9, 6, 'abcdef', 9);
INSERT INTO sub_test VALUES(10, 9, 'bcdefg', 21);
INSERT INTO sub_test VALUES(11, 2, 'cdefgh', 67);
INSERT INTO sub_test VALUES(12, 3, 'abefgh', 21);
INSERT INTO sub_test VALUES(13, 4, 'aefghi', 37);
INSERT INTO sub_test VALUES(14, 3, 'abcfgh', 21);
INSERT INTO sub_test VALUES(15, 4, 'cdeghes', 52);
INSERT INTO sub_test VALUES(16, 7, 'cdghasdf', 18);
INSERT INTO sub_test VALUES(17, 5, 'poijjs', 21);
INSERT INTO sub_test VALUES(18, 6, 'lkjhhd', 25);
INSERT INTO sub_test VALUES(19, 2, 'csadfdsafads', 4);
INSERT INTO sub_test VALUES(20, 1, 'dwqfwqfwq', 76);
SELECT * FROM sub_test;
SELECT * FROM s_updation;
SELECT * FROM s_updation_row;
SELECT * FROM s_updation_field;


DROP TABLE sub_test;
CREATE TABLE sub_test (
	id VARCHAR(32) NOT NULL,
	test_id INT(11),
	eee VARCHAR(20) NOT NULL,
	fff INT(10),
	bbdd DECIMAL(10, 4),
	ddd1 TIMESTAMP,
	ddd2 DATETIME DEFAULT NULL,
	ddd3 DATE DEFAULT NULL,
	PRIMARY KEY (id),
	KEY idx_xxx(test_id, fff) USING BTREE,
	KEY idx_www(fff, test_id) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP INDEX idx_xxx ON sub_test;
CREATE INDEX idx_xxx ON sub_test(fff, test_id);
DROP INDEX idx_www ON sub_test;
CREATE INDEX idx_www ON sub_test(test_id, fff);
DROP INDEX idx_fff ON sub_test;
CREATE INDEX idx_fff ON sub_test(fff);


DELETE FROM s_updation;
DELETE FROM s_updation_row;
DELETE FROM s_updation_field;
DELETE FROM test;
INSERT INTO test VALUES(1, 'aaa1', 15);
INSERT INTO test VALUES(2, 'aaa2', 5);
INSERT INTO test VALUES(3, 'aaa3', 32);
INSERT INTO test VALUES(4, 'aaa4', 56);
INSERT INTO test VALUES(5, 'aaa5', 87);
INSERT INTO test VALUES(6, 'aaa6', 2);
INSERT INTO test VALUES(7, 'aaa7', 7);
INSERT INTO test VALUES(8, 'aaa8', 12);
INSERT INTO test VALUES(9, 'aaa9', 9);
INSERT INTO test VALUES(10, 'aaa0', 21);
SELECT * FROM test ORDER BY bbb;
DELETE FROM sub_test;
INSERT INTO sub_test VALUES('a', 6, 'abcd', 15, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('b', 2, 'bcde', 5, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('c', 5, 'cdef', 21, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('d', 7, 'defg', 56, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('e', 1, 'efgh', 13, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('f', 10, 'fghi', 2, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('g', 3, 'ghij', 7, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('h', 9, 'hijk', 12, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('i', 6, 'abcdef', 9, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('j', 9, 'bcdefg', 21, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('k', 2, 'cdefgh', 67, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('l', 3, 'abefgh', 21, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('m', 4, 'aefghi', 37, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('n', 3, 'abcfgh', 21, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('o', 4, 'cdeghes', 52, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('p', 7, 'cdghasdf', 18, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('q', 5, 'poijjs', 21, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('r', 6, 'lkjhhd', 25, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('s', 2, 'csadfdsafads', 4, 3.1416, NOW(), NOW(), NOW());
INSERT INTO sub_test VALUES('t', 1, 'dwqfwqfwq', 76, 3.1416, NOW(), NOW(), NOW());
SELECT * FROM sub_test;


INSERT INTO sub_test VALUES('u', NULL, 'dwqfwqfwq', 57, 3.1416, NOW(), NOW(), NOW());
UPDATE sub_test SET eee=CONCAT(eee, 'yyy') WHERE id='o';
UPDATE sub_test SET eee=CONCAT(eee, 'yyy') WHERE id='l';



SELECT u.data_id,f.name,f.old_value,f.new_value,u.id,u.creation_time FROM s_updation_field f LEFT OUTER JOIN s_updation u ON f.p_id=u.id WHERE u.table_name='sub_test' AND u.creation_time BETWEEN '2024-07-24 15:30:00' AND '2024-07-24 16:30:00' ORDER BY u.creation_time DESC,u.data_id;


UPDATE test t INNER JOIN sub_test s ON t.id=s.test_id SET t.aaa='www',s.eee='xxx' WHERE s.fff=21;


EXPLAIN 
SELECT u.ddd FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ccc='asdfasd';


不加任何索引
EXPLAIN 
SELECT u.ccc FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                                              |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | index  | PRIMARY       | PRIMARY | 4       | NULL             |   10 |   100.00 | Using index                                        |
|  1 | SIMPLE      | r     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   13 |    10.00 | Using where; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.uest_id |    1 |   100.00 | NULL                                               |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+

说明单查关系表会将关系表当作子表先查
EXPLAIN 
SELECT u.ccc FROM uest u INNER JOIN zelation r ON u.id=r.uest_id;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+
|  1 | SIMPLE      | r     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   13 |   100.00 | NULL  |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.uest_id |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+
EXPLAIN 
SELECT t.aaa FROM test t INNER JOIN zelation r ON t.id=r.test_id;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+
|  1 | SIMPLE      | r     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   13 |   100.00 | NULL  |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------+


test_id, uest_id组合：test表关联关系表时走了索引，体现为：ref、rows=1、filtered=100%
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | index  | PRIMARY       | idx_bbb | 4       | NULL             |   10 |   100.00 | Using index |
|  1 | SIMPLE      | r     | NULL       | ref    | idx_xxx       | idx_xxx | 4       | ducati.t.id      |    1 |   100.00 | Using index |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.uest_id |    1 |   100.00 | NULL        |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
uest_id, test_id组合：test表关联关系表时没走索引，体现为：index、rows=13、filtered=10%
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | index  | PRIMARY       | idx_bbb | 4       | NULL             |   10 |   100.00 | Using index                                                     |
|  1 | SIMPLE      | r     | NULL       | index  | idx_xxx       | idx_xxx | 12      | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.uest_id |    1 |   100.00 | NULL                                                            |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
说明这种情况给关系表建索引时应该考虑将数据量少的表的外键字段放在最前面

EXPLAIN 
SELECT u.* FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ccc='asdfasd';
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | u     | NULL       | ALL    | PRIMARY       | NULL    | NULL    | NULL             |   20 |    10.00 | Using where                                                     |
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids       | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index                                                     |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+

EXPLAIN 
SELECT u.ddd FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd=5;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | u     | NULL       | ref    | PRIMARY,idx_ddd | idx_ddd | 4       | const            |    1 |   100.00 | Using index                                                     |
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index                                                     |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+

EXPLAIN 
SELECT u.* FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd=5;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | u     | NULL       | ref    | PRIMARY,idx_ddd | idx_ddd | 4       | const            |    1 |   100.00 | NULL                                                            |
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index                                                     |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+

EXPLAIN
SELECT u.ddd FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd>5;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | index  | PRIMARY         | idx_bbb | 4       | NULL             |   10 |   100.00 | Using index |
|  1 | SIMPLE      | r     | NULL       | ref    | idx_ids         | idx_ids | 4       | ducati.t.id      |    1 |   100.00 | Using index |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY,idx_ddd | PRIMARY | 4       | ducati.r.uest_id |    1 |    85.00 | Using where |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+

EXPLAIN
SELECT u.* FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd>5;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | index  | PRIMARY         | idx_bbb | 4       | NULL             |   10 |   100.00 | Using index |
|  1 | SIMPLE      | r     | NULL       | ref    | idx_ids         | idx_ids | 4       | ducati.t.id      |    1 |   100.00 | Using index |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY,idx_ddd | PRIMARY | 4       | ducati.r.uest_id |    1 |    85.00 | Using where |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+


EXPLAIN 
SELECT u.ddd FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd BETWEEN 5 AND 23;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |   100.00 | Using index |
|  1 | SIMPLE      | u     | NULL       | eq_ref | PRIMARY,idx_ddd | PRIMARY | 4       | ducati.r.uest_id |    1 |    40.00 | Using where |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+

EXPLAIN 
SELECT u.* FROM uest u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id WHERE u.ddd BETWEEN 5 AND 23;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | u     | NULL       | ALL    | PRIMARY,idx_ddd | NULL    | NULL    | NULL             |   20 |    40.00 | Using where                                                     |
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index                                                     |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+

EXPLAIN 
SELECT u.* FROM (SELECT id,ddd FROM uest WHERE ddd BETWEEN 5 AND 23) u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |   100.00 | Using index |
|  1 | SIMPLE      | uest  | NULL       | eq_ref | PRIMARY,idx_ddd | PRIMARY | 4       | ducati.r.uest_id |    1 |    40.00 | Using where |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-------------+

EXPLAIN
SELECT u.* FROM (SELECT * FROM uest WHERE ddd BETWEEN 5 AND 23) u INNER JOIN zelation r ON u.id=r.uest_id INNER JOIN test t ON r.test_id=t.id;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | uest  | NULL       | ALL    | PRIMARY,idx_ddd | NULL    | NULL    | NULL             |   20 |    40.00 | Using where                                                     |
|  1 | SIMPLE      | r     | NULL       | index  | idx_ids         | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index                                                     |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+-----------------------------------------------------------------+

EXPLAIN 
SELECT u.ddd FROM uest u WHERE EXISTS(SELECT * FROM zelation r WHERE u.id=r.uest_id AND EXISTS(SELECT * FROM test t WHERE r.test_id=t.id)) AND u.ddd BETWEEN 5 AND 23;
+----+--------------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
| id | select_type        | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                    |
+----+--------------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
|  1 | PRIMARY            | u     | NULL       | range  | idx_ddd       | idx_ddd | 4       | NULL             |    8 |   100.00 | Using where; Using index |
|  2 | DEPENDENT SUBQUERY | r     | NULL       | index  | NULL          | idx_ids | 8       | NULL             |   13 |    10.00 | Using where; Using index |
|  3 | DEPENDENT SUBQUERY | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | Using index              |
+----+--------------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+

EXPLAIN
SELECT u.ddd FROM uest u WHERE u.id IN (SELECT r.uest_id FROM zelation r WHERE r.test_id IN (SELECT t.id FROM test t)) AND u.ddd BETWEEN 5 AND 23;
+----+--------------+-------------+------------+--------+-----------------+------------+---------+-------------+------+----------+--------------------------+
| id | select_type  | table       | partitions | type   | possible_keys   | key        | key_len | ref         | rows | filtered | Extra                    |
+----+--------------+-------------+------------+--------+-----------------+------------+---------+-------------+------+----------+--------------------------+
|  1 | SIMPLE       | u           | NULL       | range  | PRIMARY,idx_ddd | idx_ddd    | 4       | NULL        |    8 |   100.00 | Using where; Using index |
|  1 | SIMPLE       | <subquery2> | NULL       | eq_ref | <auto_key>      | <auto_key> | 4       | ducati.u.id |    1 |   100.00 | NULL                     |
|  2 | MATERIALIZED | t           | NULL       | index  | PRIMARY         | PRIMARY    | 4       | NULL        |   10 |   100.00 | Using index              |
|  2 | MATERIALIZED | r           | NULL       | ref    | idx_ids         | idx_ids    | 4       | ducati.t.id |    1 |   100.00 | Using index              |
+----+--------------+-------------+------------+--------+-----------------+------------+---------+-------------+------+----------+--------------------------+

========================================================================================================================================================================
不加任何索引
EXPLAIN 
SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | s     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   20 |   100.00 | Using where |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | NULL        |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+

EXPLAIN 
SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE s.fff=21;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra       |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE      | s     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   20 |    10.00 | Using where |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | Using index |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+-------------+

EXPLAIN 
SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE t.bbb=21;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | ALL  | PRIMARY       | NULL | NULL    | NULL |   10 |    10.00 | Using where                                        |
|  1 | SIMPLE      | s     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   20 |    10.00 | Using where; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+

test_id,fff联合
不加条件：说明会挑一张数据量少的表先查
+----+-------------+-------+------------+-------+---------------+---------+---------+-------------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref         | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | index | PRIMARY       | idx_bbb | 4       | NULL        |   10 |   100.00 | Using index |
|  1 | SIMPLE      | s     | NULL       | ref   | idx_xxx       | idx_xxx | 4       | ducati.t.id |    2 |   100.00 | Using index |
+----+-------------+-------+------------+-------+---------------+---------+---------+-------------+------+----------+-------------+
虽然s.fff=21条件使子表提升至先查询，但是fff在索引顺序中没有最左匹配到，所以type列体现的不是ref，index仅仅说明查询字段来自索引，rows=20表明s.fff=21并没有起作用，因为二次过滤没有索引可走了
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                    |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
|  1 | SIMPLE      | s     | NULL       | index  | idx_xxx       | idx_xxx | 8       | NULL             |   20 |    10.00 | Using where; Using index |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | Using index              |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+

fff,test_id联合
EXPLAIN SELECT t.id,t.bbb FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE s.fff=21;
不加条件：说明test_id如果没有索引或不在第一个，先查子表
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                    |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
|  1 | SIMPLE      | s     | NULL       | index  | NULL          | idx_xxx | 9       | NULL             |   20 |   100.00 | Using where; Using index |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | NULL                     |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
rows=5说明s.fff=21起作用了，但是key_len=4说明test_id没起作用，因为二次过滤没有索引可走了
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                    |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
|  1 | SIMPLE      | s     | NULL       | ref    | idx_xxx       | idx_xxx | 4       | const            |    5 |   100.00 | Using where; Using index |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | NULL                     |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+--------------------------+
说明如果子表外键匹配不上
EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE t.bbb=21;
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type  | possible_keys   | key     | key_len | ref   | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | ref   | PRIMARY,idx_bbb | idx_bbb | 4       | const |    1 |   100.00 | Using index                                                     |
|  1 | SIMPLE      | s     | NULL       | index | NULL            | idx_xxx | 9       | NULL  |   20 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE t.bbb=21 AND s.fff=21;
多加条件效率最高
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys   | key     | key_len | ref               | rows | filtered | Extra       |
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | ref  | PRIMARY,idx_bbb | idx_bbb | 4       | const             |    1 |   100.00 | Using index |
|  1 | SIMPLE      | s     | NULL       | ref  | idx_xxx         | idx_xxx | 9       | const,ducati.t.id |    1 |   100.00 | Using index |
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+

查询条件不在子表上，查询子表没走任何索引，index仅仅表示查询字段s.fff来自索引
EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE t.bbb=21;
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type  | possible_keys   | key     | key_len | ref   | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | ref   | PRIMARY,idx_bbb | idx_bbb | 4       | const |    1 |   100.00 | Using index                                                     |
|  1 | SIMPLE      | s     | NULL       | index | NULL            | idx_xxx | 9       | NULL  |   20 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------------+-------+-----------------+---------+---------+-------+------+----------+-----------------------------------------------------------------+
EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE t.bbb IN (13, 21);
+----+-------------+-------+------------+-------+-----------------+---------+---------+------+------+----------+-----------------------------------------------------------------+
| id | select_type | table | partitions | type  | possible_keys   | key     | key_len | ref  | rows | filtered | Extra                                                           |
+----+-------------+-------+------------+-------+-----------------+---------+---------+------+------+----------+-----------------------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | range | PRIMARY,idx_bbb | idx_bbb | 4       | NULL |    2 |   100.00 | Using where; Using index                                        |
|  1 | SIMPLE      | s     | NULL       | index | NULL            | idx_xxx | 8       | NULL |   20 |    10.00 | Using where; Using index; Using join buffer (Block Nested Loop) |
+----+-------------+-------+------------+-------+-----------------+---------+---------+------+------+----------+-----------------------------------------------------------------+


一主两从表：无任何索引时，从两从表中选取一个数据量少的表先查，最后查主表
EXPLAIN 
SELECT t.bbb,r.ggg,s.fff FROM test t INNER JOIN zelation r ON t.id=r.test_id INNER JOIN sub_test s ON t.id=s.test_id;
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref              | rows | filtered | Extra                                              |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+
|  1 | SIMPLE      | r     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   13 |   100.00 | Using where                                        |
|  1 | SIMPLE      | s     | NULL       | ALL    | NULL          | NULL    | NULL    | NULL             |   20 |    10.00 | Using where; Using join buffer (Block Nested Loop) |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | ducati.r.test_id |    1 |   100.00 | NULL                                               |
+----+-------------+-------+------------+--------+---------------+---------+---------+------------------+------+----------+----------------------------------------------------+


fff,test_id联合+test_id,fff联合

EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE s.fff=21;
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+--------------------------+
| id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref              | rows | filtered | Extra                    |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+--------------------------+
|  1 | SIMPLE      | s     | NULL       | ref    | idx_xxx,idx_www | idx_xxx | 5       | const            |    1 |   100.00 | Using where; Using index |
|  1 | SIMPLE      | t     | NULL       | eq_ref | PRIMARY         | PRIMARY | 4       | ducati.s.test_id |    1 |   100.00 | Using index              |
+----+-------------+-------+------------+--------+-----------------+---------+---------+------------------+------+----------+--------------------------+

EXPLAIN SELECT s.id,s.fff FROM test t INNER JOIN sub_test s ON t.id=s.test_id WHERE s.fff=21;
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys   | key     | key_len | ref               | rows | filtered | Extra       |
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+
|  1 | SIMPLE      | t     | NULL       | ref  | PRIMARY,idx_bbb | idx_bbb | 4       | const             |    1 |   100.00 | Using index |
|  1 | SIMPLE      | s     | NULL       | ref  | idx_xxx,idx_www | idx_xxx | 10      | const,ducati.t.id |    1 |   100.00 | Using index |
+----+-------------+-------+------------+------+-----------------+---------+---------+-------------------+------+----------+-------------+


EXPLAIN 
SELECT s.id,s.eee,s.fff,f.id,f.name,f.sort,v.value_decimal,v.value_str 
FROM (SELECT * FROM sub_test LIMIT 10 OFFSET 0) s 
LEFT OUTER JOIN s_dynamic_field_val v ON s.id=v.business_id_str OR s.id=v.business_id_int 
LEFT OUTER JOIN (SELECT * FROM s_dynamic_field WHERE table_name='sub_test' ORDER BY sort) f ON v.field_id=f.id;
+----+-------------+-----------------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------------------------------------------+
| id | select_type | table           | partitions | type   | possible_keys          | key     | key_len | ref               | rows | filtered | Extra                                           |
+----+-------------+-----------------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------------------------------------------+
|  1 | PRIMARY     | <derived2>      | NULL       | ALL    | NULL                   | NULL    | NULL    | NULL              |    5 |   100.00 | NULL                                            |
|  1 | PRIMARY     | v               | NULL       | ALL    | idx_xxx,idx_www        | NULL    | NULL    | NULL              |   17 |   100.00 | Range checked for each record (index map: 0x18) |
|  1 | PRIMARY     | s_dynamic_field | NULL       | eq_ref | PRIMARY,idx_table_name | PRIMARY | 4       | ducati.v.field_id |    1 |   100.00 | Using where                                     |
|  2 | DERIVED     | sub_test        | NULL       | ref    | idx_xxx                | idx_xxx | 5       | const             |    5 |   100.00 | NULL                                            |
+----+-------------+-----------------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------------------------------------------+

EXPLAIN 
SELECT s.id,s.eee,s.fff,s.id,f.id,f.name,v.value_decimal 
FROM (SELECT * FROM sub_test LIMIT 10 OFFSET 0) s 
INNER JOIN s_dynamic_field_val v ON s.id=v.business_id_str 
INNER JOIN (SELECT * FROM s_dynamic_field ORDER BY sort) f ON v.field_id=f.id AND f.table_name='sub_test';
+----+-------------+-----------------+------------+------+-------------------------+----------------+---------+---------------------------+------+----------+-------------+
| id | select_type | table           | partitions | type | possible_keys           | key            | key_len | ref                       | rows | filtered | Extra       |
+----+-------------+-----------------+------------+------+-------------------------+----------------+---------+---------------------------+------+----------+-------------+
|  1 | PRIMARY     | s_dynamic_field | NULL       | ref  | PRIMARY,idx_table_name  | idx_table_name | 152     | const                     |    3 |   100.00 | Using index |
|  1 | PRIMARY     | v               | NULL       | ref  | unq_xxx,unq_www,idx_www | unq_xxx        | 4       | ducati.s_dynamic_field.id |    5 |   100.00 | Using where |
|  1 | PRIMARY     | <derived2>      | NULL       | ref  | <auto_key0>             | <auto_key0>    | 98      | ducati.v.business_id_str  |    2 |   100.00 | Using where |
|  2 | DERIVED     | sub_test        | NULL       | ALL  | NULL                    | NULL           | NULL    | NULL                      |   20 |   100.00 | NULL        |
+----+-------------+-----------------+------------+------+-------------------------+----------------+---------+---------------------------+------+----------+-------------+

DELETE FROM s_dynamic_field;
INSERT INTO s_dynamic_field VALUES(1, 'sub_test', 'item1', 3);
INSERT INTO s_dynamic_field VALUES(2, 'sub_test', 'item2', 1);
INSERT INTO s_dynamic_field VALUES(3, 'sub_test', 'item3', 2);

DELTE FROM s_dynamic_field_val;
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'h', 123.32);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'i', 342.43);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'j', 3545.23);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'k', 7645.23);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'l', 453.12);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_str) VALUES(2, 'h', 'aaa');
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_str) VALUES(2, 'i', 'and');
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'h', 78424.67);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'i', 234434.78);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'j', 765.52);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'k', 435.76);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'm', 23423.28);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_str) VALUES(2, 'j', 'ghfjg');
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'm', 12312.92);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'n', 435.18);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_str) VALUES(2, 'k', 'tyru');
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'l', 32.83);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'c', 874.83);
INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(1, 'c', 2345.56);
SELECT * FROM s_dynamic_field_val;

INSERT INTO s_dynamic_field_val(field_id, business_id_str, value_decimal) VALUES(3, 'h', 675.75);

DELETE FROM s_dynamic_field_val WHERE field_id=2;


+----+--------------+------+----+------+-------+---------------+
| id | eee          | fff  | id | id   | name  | value_decimal |
+----+--------------+------+----+------+-------+---------------+
| h  | hijk         |   12 | h  |    1 | item1 |      123.3200 |
| i  | abcdef       |    9 | i  |    1 | item1 |      342.4300 |
| j  | bcdefg       |   21 | j  |    1 | item1 |     3545.2300 |
| k  | cdefgh       |   67 | k  |    1 | item1 |     7645.2300 |
| l  | abefgh       |   21 | l  |    1 | item1 |      453.1200 |
| m  | aefghi       |   37 | m  |    1 | item1 |    23423.2800 |
| n  | abcfgh       |   21 | n  |    1 | item1 |      435.1800 |
| h  | hijk         |   12 | h  |    2 | item2 |   324234.7800 |
| i  | abcdef       |    9 | i  |    2 | item2 |     3324.4500 |
| j  | bcdefg       |   21 | j  |    2 | item2 |      453.5900 |
| k  | cdefgh       |   67 | k  |    2 | item2 |     4352.7300 |
| h  | hijk         |   12 | h  |    3 | item3 |    78424.6700 |
| i  | abcdef       |    9 | i  |    3 | item3 |   234434.7800 |
| j  | bcdefg       |   21 | j  |    3 | item3 |      765.5200 |
| k  | cdefgh       |   67 | k  |    3 | item3 |      435.7600 |
| l  | abefgh       |   21 | l  |    3 | item3 |       32.8300 |
| m  | aefghi       |   37 | m  |    3 | item3 |    12312.9200 |
| a  | abcd         |   15 | a  | NULL | NULL  |          NULL |
| b  | bcde         |    5 | b  | NULL | NULL  |          NULL |
| c  | cdef         |   21 | c  | NULL | NULL  |          NULL |
| d  | defg         |   56 | d  | NULL | NULL  |          NULL |
| e  | efgh         |   13 | e  | NULL | NULL  |          NULL |
| f  | fghi         |    2 | f  | NULL | NULL  |          NULL |
| g  | ghij         |    7 | g  | NULL | NULL  |          NULL |
| o  | cdeghes      |   52 | o  | NULL | NULL  |          NULL |
| p  | cdghasdf     |   18 | p  | NULL | NULL  |          NULL |
| q  | poijjs       |   21 | q  | NULL | NULL  |          NULL |
| r  | lkjhhd       |   25 | r  | NULL | NULL  |          NULL |
| s  | csadfdsafads |    4 | s  | NULL | NULL  |          NULL |
| t  | dwqfwqfwq    |   76 | t  | NULL | NULL  |          NULL |
+----+--------------+------+----+------+-------+---------------+



ALTER TABLE sub_test ADD COLUMN aaa BIGINT;
ALTER TABLE sub_test ADD COLUMN bbb MEDIUMINT;
ALTER TABLE sub_test ADD COLUMN ccc SMALLINT;
ALTER TABLE sub_test ADD COLUMN ddd TINYINT;
ALTER TABLE sub_test ADD COLUMN ddd4 TIME;

ALTER TABLE sub_test DROP COLUMN aaa;
ALTER TABLE sub_test DROP COLUMN bbb;
ALTER TABLE sub_test DROP COLUMN ccc;
ALTER TABLE sub_test DROP COLUMN ddd;
ALTER TABLE sub_test DROP COLUMN ddd4;

